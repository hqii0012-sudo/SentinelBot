<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程监督平台 - AI问答</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="qna-body">
    <!-- 顶部 Header -->
    <header class="qna-header">
        <div class="qna-header-left">
            <div class="qna-logo">
                <img src="SentinelBot.png" alt="SentinelBot Logo" class="qna-logo-image">
            </div>
            <div class="qna-title">
                <span class="qna-title-main">纪小白智能问答</span>
            </div>
        </div>
        <div class="qna-header-right">
            <button class="qna-export-btn">
                <i class="bi bi-download"></i>
                导出对话
            </button>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="qna-container">
        <!-- 左侧 Sidebar -->
        <aside class="qna-sidebar">
            <div class="qna-new-chat">
                <button class="qna-new-btn">
                    <i class="bi bi-plus"></i>
                    新对话
                </button>
            </div>
            <div class="qna-chat-list">
                <div class="qna-chat-item active">
                    <div class="qna-chat-title">新对话 1</div>
                    <div class="qna-chat-time">刚刚</div>
                </div>
                <div class="qna-chat-item">
                    <div class="qna-chat-title">供应商合规咨询</div>
                    <div class="qna-chat-time">2小时前</div>
                </div>
                <div class="qna-chat-item">
                    <div class="qna-chat-title">招投标流程问题</div>
                    <div class="qna-chat-time">昨天</div>
                </div>
            </div>
        </aside>

        <!-- 中间 Chat Area -->
        <main class="qna-chat-area">
            <div id="chatContainer" class="qna-chat-container">
                <div class="qna-message assistant">
                    <div class="qna-avatar">
                        <img src="SentinelBot.png" alt="SentinelBot" class="qna-avatar-image">
                    </div>
                    <div class="qna-message-content">
                        <div class="qna-message-text">您好！我是工程监督平台的AI助手纪小白，有什么可以帮助您的吗？</div>
                    </div>
                </div>
            </div>

            <!-- 底部输入区 -->
            <div class="qna-input-area">
                <div class="qna-input-container">
                    <textarea 
                        id="queryInput" 
                        class="qna-input" 
                        placeholder="输入问题，发送 [Enter] / 换行 [Shift+Enter]"
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="qna-send-btn" onclick="sendMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // 对话ID，用于多轮对话
        let conversationId = null;

        // 发送消息
        async function sendMessage() {
            const queryInput = document.getElementById('queryInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatContainer = document.getElementById('chatContainer');
            const errorCard = document.getElementById('errorCard');
            const errorMessage = document.getElementById('errorMessage');

            const query = queryInput.value.trim();
            
            if (!query) {
                alert('请输入问题');
                return;
            }

            // 设置按钮为加载状态
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');
            sendBtn.textContent = '发送中...';

            // 隐藏错误状态
            errorCard.style.display = 'none';

            // 添加用户消息到对话区域
            addMessage('user', query);
            
            // 清空输入框
            queryInput.value = '';

            try {
                // 调用问答API
                const data = await api('/api/ask', { 
                    query: query, 
                    conversation_id: conversationId 
                });
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // 更新对话ID
                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                }

                // 添加AI回复到对话区域
                addMessage('assistant', data.answer);

            } catch (error) {
                console.error('发送消息失败:', error);
                
                // 显示错误状态
                errorMessage.textContent = `发送失败: ${error.message}`;
                errorCard.style.display = 'block';
                
                // 添加错误消息到对话区域
                addMessage('assistant', '抱歉，我暂时无法回答您的问题，请稍后重试。');
            } finally {
                // 恢复按钮状态
                sendBtn.disabled = false;
                sendBtn.classList.remove('loading');
                sendBtn.textContent = '发送';
            }
        }

        // 添加消息到对话区域
        function addMessage(sender, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `qna-message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="qna-message-content">
                        <div class="qna-message-text">${content}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="qna-avatar">
                        <img src="SentinelBot.png" alt="SentinelBot" class="qna-avatar-image">
                    </div>
                    <div class="qna-message-content">
                        <div class="qna-message-text">${content}</div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            
            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 清空对话
        function clearChat() {
            if (confirm('确定要清空所有对话记录吗？')) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    <div class="qna-message assistant">
                        <div class="qna-avatar">
                            <img src="SentinelBot.png" alt="SentinelBot" class="qna-avatar-image">
                        </div>
                        <div class="qna-message-content">
                            <div class="qna-message-text">您好！我是工程监督平台的AI助手纪小白，有什么可以帮助您的吗？</div>
                        </div>
                    </div>
                `;
                conversationId = null;
            }
        }

        // 回车键发送消息（Shift+Enter换行）
        document.getElementById('queryInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 自动调整输入框高度
        document.getElementById('queryInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // 自动聚焦到输入框
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('queryInput').focus();
        });
    </script>
</body>
</html>
